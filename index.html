<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DOSBox</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Яндекс.РТБ -->
    <script>
        window.yaContextCb = window.yaContextCb || [];
    </script>
    <script src="https://yandex.ru/ads/system/context.js" async></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1d232b;
        }
        #dos {
            width: 100%;
            height: 100%;
        }
        .bg-black.h-full.flex-grow.overflow-hidden.relative {
            background-color: #1d232b !important;
        }
        .absolute.right-10.bottom-10.pointer-events-none.opacity-50,
        .absolute.right-10.bottom-10.pointer-events-none.opacity-80 {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1d232b;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            pointer-events: all;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #3c4959;
            border-top: 5px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        body {
          user-select: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
        }
        * {
          user-select: none;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
        }
        /* Добавьте этот код здесь */
        .text-xl,
        .text-sm {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Баннер */
        /* Стили для рекламного блока */
        #side-ad {
            position: fixed;
            top: 0;
            right: -320px; /* Скрыт за пределами экрана */
            width: 300px;
            height: 100vh;
            background: #2c3e50;
            z-index: 10000;
            transition: right 0.5s ease-in-out;
            border-left: 2px solid #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: Arial, sans-serif;
        }

        #side-ad.show {
            right: 0; /* Показываем блок */
        }

        #side-ad .ad-content {
            text-align: center;
            padding: 20px;
        }

        #side-ad .ad-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        /* Сдвигаем игровой блок когда реклама показана */
        body.ad-shown #dos {
            margin-right: 300px;
            transition: margin-right 0.5s ease-in-out;
        }
    </style>
</head>
<body oncontextmenu="return false;"
      onselectstart="return false;"
      ondragstart="return false;"
      style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
    <div id="loading-screen">
        <div class="loader"></div>
    </div>

    <div id="dos"></div>

    <!-- Рекламный блок -->
    <div id="side-ad">
        <button class="ad-close" onclick="closeAd()">×</button>
        <div class="ad-content">
            <h3>Реклама</h3>
            <p>Здесь может быть ваша реклама</p>
            <!-- Yandex.RTB R-A-1343857-7 -->
            <div id="yandex_rtb_R-A-1343857-7"></div>
        </div>
    </div>

    <script>
        // Инициализируем VK Bridge и приложение
        async function initApp() {
            try {
                // 1. Отправляем клиенту (приложению ВКонтакте) сигнал об инициализации
                await vkBridge.send('VKWebAppInit');

                // 2. Запрашиваем ключ доступа (токен) пользователя.
                // Без этого ключа вызов большинства API-методов, включая показ рекламы, невозможен.
                const tokenData = await vkBridge.send('VKWebAppGetAuthToken', {
                    app_id: 54207808, // Замените на ID вашего приложения
                    scope: 'ads' // Запрашиваем право на показ рекламы
                });

                const accessToken = tokenData.access_token;

                // 3. Показываем рекламу
                // Этот метод показывает полноэкранную рекламу (interstitial).
                const adResult = await vkBridge.send('VKWebAppShowNativeAds', {
                    ad_format: 'interstitial' // Межстраничный баннер
                });

                // Проверяем результат показа рекламы
                if (adResult.result) {
                    // Реклама была показана (пользователь мог закрыть ее)
                    console.log("Реклама показана успешно");
                } else {
                    // Реклама не была показана (например, нет заполнения)
                    console.log("Не удалось показать рекламу");
                }

                // 4. После показа рекламы запускаем основную логику вашей игры
                loadGameResources();
                // 5. Запускаем таймер для боковой рекламы
                scheduleSideAd();

            } catch (error) {
                // Обработка ошибок (например, пользователь отказал в выдаче прав)
                console.error('Ошибка:', error);
                loadGameResources();
                scheduleSideAd();
            }
        }

        function loadGameResources() {
            // Динамически загружаем js-dos ресурсы
            const cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = 'js-dos.css';
            document.head.appendChild(cssLink);

            const script = document.createElement('script');
            script.src = 'js-dos.js';
            script.onload = function() {
                // Когда js-dos загружен, запускаем игру
                StartGameLoading();
            };
            document.head.appendChild(script);
        }

        function StartGameLoading() {
            document.getElementById('loading-screen').style.display = 'none';
            let game_url = 'game.jsdos'; // значение по умолчанию
            initializeGame(game_url);

            function initializeGame(gameUrl) {
                props = Dos(document.getElementById('dos'), {
                    url: gameUrl,
                    softFullscreen: true,
                    autoStart: true,
                    autoSave: true,
                    noCloud: true,
                    kiosk: true,
                    lang: 'ru',
                    theme: 'dark',
                    pathPrefix: '',
                    noCursor: true,
                    //mouseSensitivity: 1.0,
                    //mouseCapture: true,
                    onEvent: function(event, ci) {
                        // Логируем специфические события с дополнительной информацией
                        switch (event) {
                            case 'emu-ready':
                                document.getElementById('loading-screen').style.display = 'flex';

                                console.log('Эмулятор готов к работе');
                                break;
                            case 'ci-ready':

                                  setTimeout(() => {
                                    const enterDownEvent = new KeyboardEvent('keydown', {
                                        key: 'Enter',
                                        code: 'Enter',
                                        keyCode: 13,
                                        which: 13,
                                        bubbles: true
                                    });
                                    const enterUpEvent = new KeyboardEvent('keyup', {
                                        key: 'Enter',
                                        code: 'Enter',
                                        keyCode: 13,
                                        which: 13,
                                        bubbles: true
                                    });

                                    document.dispatchEvent(enterDownEvent);
                                    document.dispatchEvent(enterUpEvent);
                                    console.log('Enter нажат');

                                    const exitInterval = setInterval(() => {
                                        if (ci.exited) {
                                            // Определяем текст в зависимости от языка
                                            let endGameText = 'Игра завершена. Игра не "зависла", Вы можете продолжить игру. Нажмите любую клавишу для перезапуска';

                                            console.log("Полная очистка страницы");

                                            // Создаем div для сообщения, который перекрывает весь контент
                                            const messageDiv = document.createElement('div');
                                            messageDiv.innerHTML = `
                                                <div style="
                                                    position: fixed;
                                                    top: 0;
                                                    left: 0;
                                                    width: 100%;
                                                    height: 100%;
                                                    display: flex;
                                                    justify-content: center;
                                                    align-items: center;
                                                    background-color: #1d232b;
                                                    color: white;
                                                    font-family: Arial, sans-serif;
                                                    font-size: 24px;
                                                    text-align: center;
                                                    z-index: 9999;
                                                ">
                                                    ${endGameText}
                                                </div>
                                            `;

                                            document.body.appendChild(messageDiv);

                                            // Обработчик перезагрузки (сработает только один раз)
                                            const restartGame = () => {

                                                // Удаляем все обработчики событий
                                                document.removeEventListener('keydown', restartGame);
                                                document.removeEventListener('mousedown', restartGame);
                                                document.removeEventListener('touchstart', restartGame);

                                                // Удаляем сообщение
                                                if (messageDiv.parentNode) {
                                                    messageDiv.parentNode.removeChild(messageDiv);
                                                }

                                                // Затем запускаем загрузку игры
                                                StartGameLoading();
                                            };

                                            // Вешаем обработчики на все типы ввода
                                            document.addEventListener('keydown', restartGame, { once: true });
                                            document.addEventListener('mousedown', restartGame, { once: true });
                                            document.addEventListener('touchstart', restartGame, { once: true });

                                            clearInterval(exitInterval); // Правильное использование
                                        }
                                    }, 100);

                                    console.log('DOS готов к выполнению команд');
                                    setTimeout(() => {
                                        document.getElementById('loading-screen').style.display = 'none';

                                        // Сохранение при любом действии пользователя
                                        const saveOnInteraction = () => {
                                            setTimeout(() => {
                                                props.save().then((success) => {
                                                    console.log('Автосохранение:', success ? 'успешно' : 'не удалось');
                                                }).catch((error) => {
                                                    console.error('Ошибка автосохранения:', error);
                                                });
                                            }, 2000);
                                        };

                                        // Сохраняем при нажатии клавиш
                                        document.addEventListener('keyup', saveOnInteraction);

                                        // Сохраняем при клике мыши
                                        document.addEventListener('mouseup', saveOnInteraction);

                                        // Сохраняем при касании на сенсорных устройствах
                                        document.addEventListener('touchend', saveOnInteraction);
                                    }, 3000);
                                }, 5000);

                                break;
                        }
                    }
                })
            }
        }

        // Таймер для показа рекламы через 1 минуту
        let adTimer;

        function scheduleSideAd() {
            // Показываем рекламу через 600 секунд
            adTimer = setTimeout(showSideAd, 1000);
        }

        function showSideAd() {
            const sideAd = document.getElementById('side-ad');
            const dosContainer = document.getElementById('dos');

            if (sideAd && dosContainer) {
                // Показываем рекламный блок
                sideAd.classList.add('show');
                // Сдвигаем игровой блок
                document.body.classList.add('ad-shown');

                // Запускаем Яндекс Рекламу
                if (window.yaContextCb) {
                    window.yaContextCb.push(() => {
                        Ya.Context.AdvManager.render({
                            "blockId": "R-A-1343857-7",
                            "renderTo": "yandex_rtb_R-A-1343857-7"
                        });
                    });
                }
            }
        }

        function closeAd() {
            const sideAd = document.getElementById('side-ad');
            const dosContainer = document.getElementById('dos');

            if (sideAd && dosContainer) {
                // Скрываем рекламный блок
                sideAd.classList.remove('show');
                // Возвращаем игровой блок на место
                document.body.classList.remove('ad-shown');

                // Можно перезапустить таймер, если нужно показывать снова
                // clearTimeout(adTimer);
                // scheduleSideAd();
            }
        }
        // Запускаем всю логику при загрузке страницы
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
